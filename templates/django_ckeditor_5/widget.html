{% if widget.value %}{{ widget.value }}{% endif %}
<textarea name="{{ widget.name }}" {% include "django/forms/widgets/attrs.html"
    %}>{% if widget.value %}{{ widget.value }}{% endif %}</textarea>

{% if errors %}
{{ errors }}
{% endif %}

<div class="ckeditor-variable-tools" id="{{ widget.attrs.id }}_variable_tools">
    <label class="ckeditor-variable-label" for="{{ widget.attrs.id }}_variable_input">
        Variable
    </label>
    <input id="{{ widget.attrs.id }}_variable_input" type="text" class="ckeditor-variable-input"
        placeholder="variable_name" autocomplete="off" />
    <button type="button" class="ckeditor-variable-insert">
        Insert variable
    </button>
</div>

<style>
    .ckeditor-variable-tools {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0 16px;
        flex-wrap: wrap;
    }

    .ckeditor-variable-label {
        font-size: 12px;
        font-weight: 600;
        color: #555;
    }

    .ckeditor-variable-input {
        min-width: 180px;
        padding: 6px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .ckeditor-variable-insert {
        padding: 6px 10px;
        border: 1px solid #888;
        border-radius: 4px;
        background: #f5f5f5;
        cursor: pointer;
    }

    .ckeditor-variable-insert:hover {
        background: #e9e9e9;
    }
</style>

<script>
    (function () {
        var editorId = "{{ widget.attrs.id }}";
        var tools = document.getElementById(editorId + "_variable_tools");
        if (!tools) {
            return;
        }

        var input = tools.querySelector(".ckeditor-variable-input");
        var button = tools.querySelector(".ckeditor-variable-insert");
        var editorInstance = null;

        function normalizeVariable(rawValue) {
            var value = (rawValue || "").trim();
            if (!value) {
                return "";
            }
            if (value.indexOf("{{") === 0 && value.lastIndexOf("}}") === value.length - 2) {
                return value;
            }
            return "{{" + value + "}}";
        }

        function resolveEditor() {
            if (editorInstance) {
                return editorInstance;
            }
            if (window.editors && window.editors[editorId]) {
                editorInstance = window.editors[editorId];
                return editorInstance;
            }
            return null;
        }

        if (window.ckeditorRegisterCallback) {
            window.ckeditorRegisterCallback(editorId, function (editor) {
                editorInstance = editor;
            });
        }

        button.addEventListener("click", function () {
            var normalized = normalizeVariable(input.value);
            if (!normalized) {
                return;
            }
            var editor = resolveEditor();
            if (!editor) {
                return;
            }
            editor.model.change(function (writer) {
                editor.model.insertContent(writer.createText(normalized));
            });
            input.value = "";
            input.focus();
        });
    })();
</script>

{{ config|json_script:script_id }}